---
title: "Activitat 3: Models predictius"
author: "Marc Cervera Rosell"
date: "2024-05-24"
output: pdf_document
---

```{r}
setRepositories(ind=2) # Per descarregar paquets de CRAN
```

# 1. Regressió lineal

## 1.1 Preparació de les dades

```{r}
tryCatch({
  data <- read.csv("Casas.csv", header = TRUE)
  print("Fitxer llegit correctament")
}, error = function(e){
  cat("ERROR en el moment de llegir el fitxer:",conditionMessage(e), "\n")
})
```

```{r}
any(is.na(data))
```

El fitxer no conté valors NA

Canvi de peus quadrats a metres quadrats i de dòlars a euros:

```{r}
for (i in seq_along(data$sqft_living)) {
  data$sqft_living[i] <- data$sqft_living[i] * 0.0929
  data$sqft_lot[i] <- data$sqft_lot[i] * 0.0929
  data$sqft_living15[i] <- data$sqft_living15[i] * 0.0929
  data$sqft_lot15[i] <- data$sqft_lot15[i] * 0.0929
  data$sqft_basement[i] <- data$sqft_basement[i] * 0.0929
  data$price[i] <- data$price[i] * 0.93
}
```

La funció _seq_along()_ ens permet iterar sobre la columna indicada i, atès que, totes les columnes tenen la mateixa longitud no hi ha problema a posar com a argument una columna o una altra.

```{r}
# Canvi de noms de les columnes afectades per les conversions monetàries i
# per les conversions del sistema imperial al sistema mètric
names(data)[names(data) == "price"] <- "price_eur"
names(data)[names(data) == "sqft_living"] <- "m2_living"
names(data)[names(data) == "sqft_lot"] <- "m2_lot"
names(data)[names(data) == "sqft_living15"] <- "m2_living15"
names(data)[names(data) == "sqft_lot15"] <- "m2_lot15"
names(data)[names(data) == "sqft_basement"] <- "m2_basement"
```

```{r}
columns <- names(data)
type <- sapply(data, class)
for (i in seq_along(columns)) {
  cat("La columna", columns[i], "és de tipus", type[i], "\n")
}
```

Després d'analitzar els tipus de les variables del fitxer es determina realitzar un canvi de tipus de les següents variables:

- _bathrooms_ -> Actualment és de tipus numèric, i no es canviarà atès que si s'observa [**l'apartat de discusions del dataset**](https://www.kaggle.com/datasets/harlfoxem/housesalesprediction/discussion/207885), es podrà veure el significat dels decimals. Per veure la web del dataset, clicar sobre el text en negreta.

- _floors_ -> Actualment és de tipus numèric. En aquest cas, no s'ha trobat cap explicació per als decimals d'aquesta variable, per tant es decideix fer el canvi a _integer_ sota la lògica de que no podem tenir mitja planta o 0.64 plantes.

```{r}
data <- transform(data,
                  floors = as.integer(floors))
```

```{r}
columns <- names(data)
type <- sapply(data, class)
for (i in seq_along(columns)) {
  cat("La columna", columns[i], "és de tipus", type[i], "\n")
}
```

Com s'observa, després d'aplicar la funció _transform()_ s'han modificat els tipus.

## 1.2 Estudi de correlació lineal

Considerant que s'han d'excloure dues de les variables del fitxer en el moment del càlcul de la correlació lineal, cal seleccionar, primer, aquelles columnes que sí que s'usaran en el càlcul.

```{r}
subset_estudi_correlacio <- data[, c("price_eur", "bedrooms", "bathrooms", "m2_living",
                                     "m2_lot", "floors", "waterfront", "view",
                                     "condition", "m2_basement", "yr_built",
                                     "yr_renovated", "m2_living15", "m2_lot15")]
```

```{r}
matriu_correlacio <- cor(subset_estudi_correlacio)
indexs <- which(matriu_correlacio > 0.2, arr.ind = TRUE)
indexs_ordenats <- indexs[order(matriu_correlacio[indexs], decreasing = TRUE), ]
files <- rownames(matriu_correlacio)[indexs_ordenats[,1]]
columnes <- colnames(matriu_correlacio)[indexs_ordenats[,2]]
matriu_noms <- cbind(files, columnes, matriu_correlacio[indexs_ordenats])
matriu_final <- matrix(matriu_noms, ncol = 3, byrow = FALSE)
colnames(matriu_final) <- c("Nom variable", "Nom variable", "Coef. Correlació")
print(matriu_final)
```

Tenint en compte que solament s'han mostrat aquells coeficients de correlació lineal majors a 0.2, es pot assegurar que la correlació lineal de les variables és positiva, és a dir, quan una de les dues variables augmenta el seu valor, la segona variable també augmenta el seu valor de manera proporcional.

En aquest cas d'estudi, el llindar s'ha establert en 0.2, per tant, aquelles parelles de variables amb un coeficient de correlació lineal proper a 0.2 tindran una correlació dèbil i aquelles parelles amb un coeficient de correlació lineal proper a 1 (o 1 en el cas del càlcul de la correlació lineal amb elles mateixes) tindran una forta correlació.

## 1.3 Generació dels conjunts d'entrenament i de test

```{r}
set.seed(123)
indexs_training <- sample(nrow(subset_estudi_correlacio), 0.8 *
                            nrow(subset_estudi_correlacio))
set_training <- subset_estudi_correlacio[indexs_training, ]
set_test <- subset_estudi_correlacio[-indexs_training, ]
```

## 1.4 Estimació del model de regressió lineal

L'ajust d'un model de regressió lineal utilitzant el mètode de mínims quadrats ordinaris es du a terme, popularment, amb la funció _lm()_.

```{r}
model <- lm(price_eur ~ ., data = set_training)
```

La variable _price_eur_, es la variable anomenada "de resposta" atès que és la variable que està a l'esquerra de la titlla ( _virgulilla_ en castellà).

### 1.4.1

```{r}
prediccions <- predict(model, newdata = set_training)
```


```{r}
coeficient_r <- 1 - (sum((set_training$price_eur - prediccions)^2) /
                       sum((set_training$price_eur - mean(set_training$price_eur))^2))
cat("Coeficient R quadrat:",coeficient_r,"\n")
fiv_model_ajustat <- 1 / (1 - coeficient_r)
cat("FIV del model ajustat:",fiv_model_ajustat)
```

Per calcular els valors dels FIV per cada una de les variables predictores del model, cal ajustar un model de regressió lineal incloent totes les variables predictores menys una. És a dir s'han de calcular els valors FIV de excloent a cada model una de les variables predictores del model original.

```{r}
valors_fiv <- data.frame(variable_exclosa = character(ncol(set_training) - 1),
                         fiv = numeric(ncol(set_training) - 1))
for (i in 2:ncol(set_training)) {
  training_aux <- set_training
  columna <- colnames(set_training)[i]
  training_aux <- training_aux[, -i]
  model_sense_variable_i <- lm(price_eur ~ ., data = training_aux)
  prediccions_aux <- predict(model_sense_variable_i, newdata = training_aux)
  coeficient_r_aux <- 1 - (sum((training_aux$price_eur - prediccions_aux)^2) /
                             sum((training_aux$price_eur - mean(training_aux$price))^2))
  fiv <- 1 / (1 - coeficient_r_aux)
  valors_fiv[i, "variable_exclosa"] <- columna
  valors_fiv[i, "fiv"] <- fiv
}
print(valors_fiv[-1, ])
```

Considerant el FIV del model ajustat i els FIVs dels models individuals, es determina que existeix colinealitat entre les variables. És a dir, l'existència de colinealitat suggereix que les variables predictores estan correlacionades. Per tant, sota la premissa de la seva rellevància teòrica, és a dir, totes les variables incloses en el model són necessàries per a obtenir tots els aspectes importants del fenomen d'estudi (explicar el preu de l'habitatge en funció de les variables seleccionades), i tot i la colinealitat, no es considera excloure cap variable del model.

## 1.5 Diagnosi del model

Per calcular els residus cal restar els valors observats i els valors reals. Per obtenir els valors predits hi ha dues opcions: la primera utilitzar una crida a la funció _predict()_ (utilitzada més amunt per al càlcul del valor de R quadrat) i posteriorment realitzar la resta, o utilitzar la funció _residuals()_ que ja retorna directament el càlcul fet.

```{r}
valors_observats <- set_training$price_eur
residus <- valors_observats - prediccions
```

```{r}
hist(residus, breaks = 100, main = "Histograma amb els residus del model",
     xlab = "Residus", ylab = "Frqüència")
```

S'observa que l'histograma s'assembla a una campana al voltant del valor 0. Aquest fet indica que els residus del model segueixen una distribució normal.

L'esmentada forma de campana al voltant del 0, és un indicador de què el model fa bones prediccions.

```{r}
plot(fitted(model), residus, main = "Gràfic d'ajustats enfront dels residus",
     xlab = "Valors ajustats", ylab = "Residus")
abline(h = 0, col = "red")
```

En el gràfic de residus enfront dels valors ajustats, es pot observar, que el model presenta certs problemes de dispersió irregular, és a dir, la variància dels residus augmenta a mesura que ho fan els valors ajustats (heteroscedasticitat).

```{r}
qqnorm(residus)
qqline(residus, col = "blue")
```

S'observa que el gràfic QQ presenta dues corbes a les cues. Aquestes curvatures són indicadores d'asimetries, és a dir, llocs on la distribució de les dades no és normal. Atès que la cua dreta és més llarga que l'esquerra es pot assegurar que hi ha una asimetria positiva (quantitat major de valors atípics en l'extrem superior).

## 1.6 Predicció del model

```{r}
prediccions_finals <- predict(model, newdata = set_test)
plot(set_test$price_eur, prediccions_finals, main = "Gràfic de prediccions finals",
     xlab = "Valors observats", ylab = "Prediccions")
abline(0, 1, col = "blue") 
```

```{r}
sumatori <- 0
for (i in 1:length(prediccions_finals)) {
  sumatori <- sumatori + ((set_test$price_eur[i] - prediccions_finals[[i]])^2)
}
rmse <- sqrt(sumatori / nrow(set_test))
cat("Valor RMSE:",rmse,"\n")
mitjana_preus <- mean(set_test$price_eur)
cat("Mitjana del preu dels habitatges:",mitjana_preus)
```

Com el RMSE està calculat en el preu dels habitatges (variable depenent), es pot interpretar el resultat del RMSE comparant amb el valor mitjà del preu dels habitatges. S'observa que el RMSE és significativament menor que el preu mitjà dels habitatges, per tant, es conclou que el model té bona precisió.

# 2 Regressió logística

## 2.1

```{r}
data$price_re <- ifelse(data$price_eur < 500000, 0, 1) # data$price < 500000 ? 0 : 1
```

```{r}
subset_estudi_correlacio_2 <- data[, c("price_re", "bedrooms", "bathrooms", "m2_living",
                                     "m2_lot", "floors", "waterfront", "view",
                                     "condition", "m2_basement", "yr_built",
                                     "yr_renovated", "m2_living15", "m2_lot15")]
set.seed(123)
indexs_training_2 <- sample(nrow(subset_estudi_correlacio_2), 0.8 *
                            nrow(subset_estudi_correlacio_2))
training2 <- subset_estudi_correlacio_2[indexs_training_2, ]
testing2 <- subset_estudi_correlacio_2[-indexs_training_2, ]
```

Com la variable _price_eur_ ha estat codificada en la variable _price_re_ i, a més a més, en l'exercici 2.2 s'especifica que la variable de preus sense codificar s'ha d'eliminar, en el subset d'estudi 2 es treuen els preus sense codificar














































